<%- include('../header') %>

<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <!-- Header Section -->
        <div class="col-12">
            <div class="bg-white rounded p-4 border shadow-sm d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                <div>
                    <h5 class="mb-1 text-dark fw-bold">Product Management</h5>
                    <p class="text-muted small mb-0">Manage your store products catalogue</p>
                </div>
                <div class="d-flex gap-2 w-100 w-md-auto">
                    <form action="/product/view-products" class="d-flex gap-2 flex-grow-1">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control bg-light border-0" name="search" placeholder="Search products..." value="<%= query.search || '' %>">
                        </div>
                    </form>
                    <button class="btn btn-light border" type="button" data-bs-toggle="collapse" data-bs-target="#filterSection" aria-expanded="false" aria-controls="filterSection">
                        <i class="bi bi-funnel"></i>
                    </button>
                    <a href="/product/add-product" class="btn btn-primary d-flex align-items-center gap-2">
                        <i class="bi bi-plus-lg"></i>
                        <span class="d-none d-sm-inline">Add Product</span>
                    </a>
                </div>
            </div>

            <!-- Filter Section (Collapsible) -->
            <div class="collapse mt-3" id="filterSection">
                <div class="bg-white rounded p-4 border shadow-sm">
                    <form action="/product/view-products" method="get">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select bg-light border-0" name="categoryId" id="categorySelect">
                                    <option value="">-- All Categories --</option>
                                    <% categories.map((cat) => { %>
                                        <option value="<%= cat.id %>" <%= query.categoryId === cat.id ? 'selected' : '' %>><%= cat.categoryName %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select bg-light border-0" name="subCategoryId" id="subCategorySelect" <%= !query.categoryId ? 'disabled' : '' %>>
                                    <option value="">-- All Sub Categories --</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select bg-light border-0" name="extraCategoryId" id="extraCategorySelect" <%= !query.subCategoryId ? 'disabled' : '' %>>
                                    <option value="">-- All Extra Categories --</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex gap-2">
                                <button type="submit" class="btn btn-primary flex-grow-1">
                                    <i class="bi bi-filter me-1"></i>Apply
                                </button>
                                <a href="/product/view-products" class="btn btn-outline-secondary d-flex align-items-center gap-2">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                    <span>Reset</span>
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Products Grid (Card Layout) -->
        <div class="col-12">
            <div class="row g-4">
                <% products.map((v, i) => { %>
                <div class="col-sm-6 col-md-4 col-xl-3">
                    <div class="card h-100 border-0 shadow-sm product-card">
                        <div class="position-relative">
                            <a href="/product/product-details/<%= v.id %>" class="text-decoration-none">
                                <% if(v.productImage) { %>
                                    <img src="<%= v.productImage %>" class="card-img-top" alt="<%= v.productName %>" style="height: 200px; object-fit: cover;">
                                <% } else { %>
                                    <div class="bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                        <i class="bi bi-image text-muted fs-1"></i>
                                    </div>
                                <% } %>
                            </a>
                            
                            <!-- Action Buttons Overlay -->
                            <div class="position-absolute top-0 end-0 p-2 d-flex gap-1">
                                <a href="/product/update-product/<%= v.id %>" class="btn btn-sm btn-light rounded-circle shadow-sm text-primary" data-bs-toggle="tooltip" title="Edit">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                                <a href="/product/delete-product/<%= v.id %>" onclick="return confirm('Are you sure you want to delete this product?')" class="btn btn-sm btn-light rounded-circle shadow-sm text-danger" data-bs-toggle="tooltip" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </a>
                            </div>
                            
                            <span class="position-absolute top-0 start-0 m-2 badge bg-white text-dark shadow-sm">
                                <%= v.categoryId ? v.categoryId.categoryName : 'Uncategorized' %>
                            </span>
                        </div>
                        
                        <div class="card-body d-flex flex-column">
                            <div class="mb-2">
                                <a href="/product/product-details/<%= v.id %>" class="text-decoration-none text-dark">
                                    <h6 class="card-title fw-bold mb-2 text-truncate"><%= v.productName %></h6>
                                </a>
                                <div class="d-flex flex-wrap gap-1 mb-2">
                                    <% if(v.subCategoryId) { %>
                                        <span class="badge bg-light text-secondary border fw-normal" title="Sub Category">
                                            <i class="bi bi-tag me-1"></i><%= v.subCategoryId.subCategoryName %>
                                        </span>
                                    <% } %>
                                    <% if(v.extraCategoryId) { %>
                                        <span class="badge bg-light text-secondary border fw-normal" title="Extra Category">
                                            <i class="bi bi-bookmarks me-1"></i><%= v.extraCategoryId.extraCategoryName %>
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                            
                            <p class="card-text text-muted small flex-grow-1" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                <%= v.productDescription %>
                            </p>
                            
                            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                <h5 class="mb-0 text-primary fw-bold">â‚¹<%= v.productPrice %></h5>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="d-inline-block rounded-circle bg-success" style="width: 8px; height: 8px;"></span>
                                    <small class="text-success fw-medium">Active</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% }) %>

                <!-- Empty State -->
                <% if (products.length === 0) { %>
                <div class="col-12">
                    <div class="bg-white rounded p-5 text-center border">
                        <div class="bg-light rounded-circle p-4 d-inline-block mb-3">
                            <i class="bi bi-box-seam text-muted fs-1"></i>
                        </div>
                        <h5 class="text-dark">No products found</h5>
                        <p class="text-muted">Start by adding your first product to the inventory.</p>
                        <a href="/product/add-product" class="btn btn-primary mt-2">Add New Product</a>
                    </div>
                </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<%- include('../footer') %>

<script>
    const categorySelect = document.getElementById('categorySelect');
    const subCategorySelect = document.getElementById('subCategorySelect');
    const extraCategorySelect = document.getElementById('extraCategorySelect');

    // Pre-populate if query params exist (for server-side rendering support, though we do it client-side for dynamic behavior)
    // Note: To fully support pre-populating dependent dropdowns on page load with existing query params, 
    // we would need to pass the selected sub/extra categories from the server or fetch them on load.
    // For now, we'll implement the change listeners.

    const initialCategoryId = "<%= query.categoryId || '' %>";
    const initialSubCategoryId = "<%= query.subCategoryId || '' %>";
    const initialExtraCategoryId = "<%= query.extraCategoryId || '' %>";

    async function loadSubCategories(categoryId, selectedId = null) {
        if (!categoryId) return;
        try {
            const response = await fetch(`/product/get-subcategories?id=${categoryId}`);
            const data = await response.json();
            
            subCategorySelect.innerHTML = '<option value="">-- All Sub Categories --</option>';
            
            if (data.subCategories && data.subCategories.length > 0) {
                data.subCategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub._id;
                    option.textContent = sub.subCategoryName;
                    if (selectedId && sub._id === selectedId) option.selected = true;
                    subCategorySelect.appendChild(option);
                });
                subCategorySelect.disabled = false;
            } else {
                subCategorySelect.disabled = true;
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    async function loadExtraCategories(subCategoryId, selectedId = null) {
        if (!subCategoryId) return;
        try {
            const response = await fetch(`/product/get-extracategories?id=${subCategoryId}`);
            const data = await response.json();
            
            extraCategorySelect.innerHTML = '<option value="">-- All Extra Categories --</option>';
            
            if (data.extraCategories && data.extraCategories.length > 0) {
                data.extraCategories.forEach(extra => {
                    const option = document.createElement('option');
                    option.value = extra._id;
                    option.textContent = extra.extraCategoryName;
                    if (selectedId && extra._id === selectedId) option.selected = true;
                    extraCategorySelect.appendChild(option);
                });
                extraCategorySelect.disabled = false;
            } else {
                extraCategorySelect.disabled = true;
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Event Listeners
    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        subCategorySelect.innerHTML = '<option value="">-- All Sub Categories --</option>';
        subCategorySelect.disabled = true;
        extraCategorySelect.innerHTML = '<option value="">-- All Extra Categories --</option>';
        extraCategorySelect.disabled = true;
        
        if (categoryId) {
            loadSubCategories(categoryId);
        }
    });

    subCategorySelect.addEventListener('change', function() {
        const subCategoryId = this.value;
        extraCategorySelect.innerHTML = '<option value="">-- All Extra Categories --</option>';
        extraCategorySelect.disabled = true;
        
        if (subCategoryId) {
            loadExtraCategories(subCategoryId);
        }
    });

    // Initialize on load if values exist
    if (initialCategoryId) {
        loadSubCategories(initialCategoryId, initialSubCategoryId).then(() => {
            if (initialSubCategoryId) {
                loadExtraCategories(initialSubCategoryId, initialExtraCategoryId);
            }
        });
    }
</script>