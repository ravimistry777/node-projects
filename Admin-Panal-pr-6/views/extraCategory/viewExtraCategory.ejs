<%- include('../header') %>

<div class="container-fluid pt-4 px-4">
    <div class="row g-4">
        <!-- Header Section -->
        <div class="col-12">
            <div class="bg-white rounded p-4 border shadow-sm d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
                <div>
                    <h5 class="mb-1 text-dark fw-bold">Extra Categories</h5>
                    <p class="text-muted small mb-0">Manage additional category layers</p>
                </div>
                <div class="d-flex gap-2 w-100 w-md-auto">
                    <form action="/extracategory/view-extracategories" class="d-flex gap-2 flex-grow-1">
                        <div class="input-group">
                            <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control bg-light border-0" name="search" placeholder="Search..." value="<%= query.search || '' %>">
                        </div>
                    </form>
                    <button class="btn btn-light border" type="button" data-bs-toggle="collapse" data-bs-target="#filterSection" aria-expanded="false" aria-controls="filterSection">
                        <i class="bi bi-funnel"></i>
                    </button>
                    <a href="/extracategory/add-extracategory" class="btn btn-primary d-flex align-items-center gap-2">
                        <i class="bi bi-plus-lg"></i>
                        <span class="d-none d-sm-inline">Add New</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Filter Section (Collapsible) -->
        <div class="col-12 collapse" id="filterSection">
            <div class="bg-white rounded p-4 border shadow-sm">
                <form action="/extracategory/view-extracategories" method="get">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <select class="form-select bg-light border-0" name="categoryId" id="categorySelect">
                                <option value="">-- All Categories --</option>
                                <% categories.map((cat) => { %>
                                    <option value="<%= cat.id %>" <%= query.categoryId === cat.id ? 'selected' : '' %>><%= cat.categoryName %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select bg-light border-0" name="subCategoryId" id="subCategorySelect" <%= !query.categoryId ? 'disabled' : '' %>>
                                <option value="">-- All Sub Categories --</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-flex gap-2">
                            <button type="submit" class="btn btn-primary flex-grow-1">
                                <i class="bi bi-filter me-1"></i>Apply Filter
                            </button>
                            <a href="/extracategory/view-extracategories" class="btn btn-outline-secondary d-flex align-items-center gap-2">
                                <i class="bi bi-arrow-counterclockwise"></i>
                                <span>Reset</span>
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Table Section -->
        <div class="col-12">
            <div class="bg-white rounded border shadow-sm overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 py-3 text-muted fw-medium" style="width: 50px;">#</th>
                                <th class="py-3 text-muted fw-medium">Extra Category</th>
                                <th class="py-3 text-muted fw-medium">Sub Category</th>
                                <th class="py-3 text-muted fw-medium">Main Category</th>
                                <th class="py-3 text-muted fw-medium">Status</th>
                                <th class="pe-4 py-3 text-end text-muted fw-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% extraCategories.map((v, i) => { %>
                            <tr>
                                <td class="ps-4 text-muted"><%= ++i %></td>
                                <td>
                                    <div class="fw-medium text-dark"><%= v.extraCategoryName %></div>
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark border fw-medium px-2">
                                        <%= v.subCategoryId ? v.subCategoryId.subCategoryName : 'Unknown' %>
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <% if(v.categoryId && v.categoryId.categoryImage) { %>
                                            <img src="<%= v.categoryId.categoryImage %>" alt="cat-img" class="rounded border" width="24" height="24" style="object-fit: cover;">
                                        <% } %>
                                        <span class="badge bg-light text-dark border fw-medium px-2">
                                            <%= v.categoryId ? v.categoryId.categoryName : 'Unknown' %>
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="d-inline-block rounded-circle bg-success" style="width: 6px; height: 6px;"></span>
                                        <span class="text-success small fw-medium">Active</span>
                                    </div>
                                </td>
                                <td class="pe-4 text-end">
                                    <div class="d-flex justify-content-end gap-1">
                                        <a href="/extracategory/delete-extracategory/<%= v.id %>" onclick="return confirm('Are you sure you want to delete this Extra Category?')" class="btn btn-sm btn-glass text-secondary border-0" data-bs-toggle="tooltip" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            <% }) %>
                            
                            <% if (extraCategories.length === 0) { %>
                            <tr>
                                <td colspan="6" class="text-center py-5">
                                    <div class="d-flex flex-column align-items-center justify-content-center">
                                        <div class="bg-light rounded-circle p-3 mb-3">
                                            <i class="bi bi-layers text-muted fs-4"></i>
                                        </div>
                                        <h6 class="text-dark mb-1">No extra categories found</h6>
                                        <p class="text-muted small mb-0">Get started by adding a new extra category.</p>
                                    </div>
                                </td>
                            </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<%- include('../footer') %>

<script>
    const categorySelect = document.getElementById('categorySelect');
    const subCategorySelect = document.getElementById('subCategorySelect');

    const initialCategoryId = "<%= query.categoryId || '' %>";
    const initialSubCategoryId = "<%= query.subCategoryId || '' %>";

    async function loadSubCategories(categoryId, selectedId = null) {
        if (!categoryId) return;
        try {
            const response = await fetch(`/product/get-subcategories?id=${categoryId}`); // Reusing product route as logic is same
            const data = await response.json();
            
            subCategorySelect.innerHTML = '<option value="">-- All Sub Categories --</option>';
            
            if (data.subCategories && data.subCategories.length > 0) {
                data.subCategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub._id;
                    option.textContent = sub.subCategoryName;
                    if (selectedId && sub._id === selectedId) option.selected = true;
                    subCategorySelect.appendChild(option);
                });
                subCategorySelect.disabled = false;
            } else {
                subCategorySelect.disabled = true;
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    categorySelect.addEventListener('change', function() {
        const categoryId = this.value;
        subCategorySelect.innerHTML = '<option value="">-- All Sub Categories --</option>';
        subCategorySelect.disabled = true;
        
        if (categoryId) {
            loadSubCategories(categoryId);
        }
    });

    if (initialCategoryId) {
        loadSubCategories(initialCategoryId, initialSubCategoryId);
    }
</script>

<%- include('../footer') %>